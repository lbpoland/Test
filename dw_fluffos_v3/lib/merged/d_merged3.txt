# Total Tokens: 21265
# Total Files Merged: 22
# Total Characters: 70947

dlers/request.c
==================================================

#include <learning.h>
#define SAVE SAVEPATH +"request"
mixed *requests;
void create() {
   seteuid( (string)master()->get_bb_uid() );
   unguarded( (: restore_object, SAVE :) );
   if( !requests ) requests = ({ });
}
void save_me() {
   unguarded( (: save_object, SAVE :) );
}
string query_list() {
   int i;
   string ret;
   mixed request;
   if ( !sizeof( requests ) ) {
      return "There are no requests at the moment.\n";
   }
   ret = "$P$Requests$P$The following requests have been made:\n";
   foreach( request in requests ) {
      if ( !request[ 1 ] ) {
         ret += sprintf( "%4d. $C$%s asked for %s.\n", i,
                        request[ 0 ], request[ 2 ] );
      } else {
         ret += sprintf( "%4d. $C$%s asked for %s.\n       Claimed by $C$%s\n", i,
                        request[ 0 ], request[ 2 ],
                        request[ 1 ]);
      }
   }
   return ret;
}
void add_request( string name, string words ) {
   requests += ({ ({ name, 0, words }) });
   save_me();
}
int claim_request( string name, int number ) {
   if ( number >= 0 && number < sizeof( requests ) ) {
      requests[ number ][ 1 ] = name;
      save_me();
      return 1;
   }
   return 0;
}
int remove_request( string name, int number ) {
   if ( number >= 0 && number < sizeof( requests ) ) {
      if ( requests[ number ][ 0 ] == name || name == CURRENT_LORD ) {
         requests = delete( requests, number, 1 );
         save_me();
         return 1;
      }
   }
   return 0;
}

==================================================
FILE: learning/handlers/search.c
==================================================

#include <learning.h>
#define SAVE SAVEPATH +"search"
mapping rooms,
        objects,
        keywords,
        functions;
string *directories;
nosave string word;
void create() {
   seteuid( (string)master()->get_bb_uid() );
   unguarded( (: restore_object, SAVE :) );
}
mixed get_keywords( string *words ) {
   string *found_words, *found_rooms, *found_objects, key, *value;
   if( sizeof( words ) ) {
      found_objects = keys( keywords );
      foreach( word in words ) {
         if( objects[ word ] ) {
            found_objects = filter_array( found_objects,
                (: member_array( $1, objects[ word ] ) != -1 :) );
         } else {
            found_objects = ({ });
         }
      }
      found_rooms = keys( keywords );
      foreach( word in words ) {
         if( rooms[ word ] ) {
            found_rooms = filter_array( found_rooms,
                (: member_array( $1, rooms[ word ] ) != -1 :) );
         } else {
            found_rooms = ({ });
         }
      }
      found_words = ({ });
      foreach( word in found_rooms ) {
         found_words -= keywords[ word ];
         found_words += keywords[ word ];
      }
      foreach( word in found_objects ) {
         found_words -= keywords[ word ];
         found_words += keywords[ word ];
      }
      found_words -= words;
   } else {
      found_rooms = ({ });
      foreach( key, value in rooms ) {
         found_rooms -= value;
         found_rooms += value;
      }
      found_objects = ({ });
      foreach( key, value in objects ) {
         found_objects -= value;
         found_objects += value;
      }
      found_words = keys( rooms );
      found_words -= keys( objects );
      found_words += keys( objects );
   }
   return ({ found_words, found_rooms, found_objects });
}
void update_info_for( string file ) {
   string *words, word;
   object obj;
   if( !catch( file->force_load() ) ) {
      obj = find_object( file );
      words = obj->query_property( "commented functions" );
      if( words ) {
         functions[ file ] = words;
      }
      words = obj->query_property( "keywords" );
      if( words ) {
         keywords[ file ] = words;
         if( function_exists( "add_exit", obj ) ) {
            foreach ( word in words ) {
               if( rooms[ word ] ) {
                  rooms[ word ] -= ({ file });
                  rooms[ word ] += ({ file });
               } else {
                  rooms[ word ] = ({ file });
               }
            }
         } else {
            foreach ( word in words ) {
               if( objects[ word ] ) {
                  objects[ word ] -= ({ file });
                  objects[ word ] += ({ file });
               } else {
                  objects[ word ] = ({ file });
               }
            }
         }
      }
      if( !directories ) {
         unguarded( (: save_object, SAVE :) );
      }
   }
}
void update_search( string room ) {
   object *obs;
   int i;
   obs = all_inventory( find_object( room ) );
   i = sizeof( obs );
   while( i--  ) {
      if ( userp( obs[ i ] ) ) {
         obs[ i ]->move( "/room/void" );
      } else {
         obs = delete( obs, i, 1 );
      }
   }
   room->dest_me();
   room->force_load();
   obs->move( room );
}
void collect_one() {
   string dir, file, *funcs;
   mixed dirs, file_info;
   dir = directories[ 0 ];
   dirs = get_dir( dir, -1 );
   if( dirs ) {
      foreach ( file_info in dirs ) {
         if( file_info[ 1 ] == -2 ) {
            if( file_info[ 0 ] != "old" ) {
               directories = directories + ({ dir + file_info[ 0 ] +"/" });
            }
         } else {
            if( ( sizeof( file_info[ 0 ] ) > 2 ) &&
                ( file_info[ 0 ][ <2 .. <1 ] == ".c" ) ) {
               update_info_for( dir + file_info[ 0 ][ 0 .. <3 ] );
            }
         }
      }
   }
   directories = directories[ 1 .. <1 ];
   if( find_call_out( "collect_one" ) == -1 && sizeof( directories ) ) {
      call_out( "collect_one", 3 );
   } else if( !sizeof( directories ) ) {
      tell_object( find_living( "olorin" ), "Collect finished.\n" );
      directories = 0;
      unguarded( (: save_object, SAVE :) );
      update_search( LEARNING +"search" );
      update_search( LEARNING +"functions" );
   }
}
void collect() {
   rooms=([ ]);
   objects=([ ]);
   functions=([ ]);
   keywords=([ ]);
   directories=({ "/d/learning/" });
   collect_one();
}
int query_collecting() {
   if( directories ) {
      return 1;
   } else {
      return 0;
   }
}
string find_room( string *words ) {
   object thing, *things;
   string word_mark;
   if( !sizeof( words ) )
     return LEARNING +"search";
   word_mark = implode( sort_array( words, 1 ), ", " );
   things = children( SEARCH_ROOM ) - ({ find_object( SEARCH_ROOM ) });
   foreach ( thing in things ) {
      if ( (string)thing->query_marker() == word_mark )
        return file_name( thing );
   }
   thing = clone_object( SEARCH_ROOM );
   thing->set_marker( word_mark, words );
   return file_name( thing );
}
string find_function_room( string word ) {
   object thing, *things;
   if( !word )
     return LEARNING +"functions";
   things = children( FUNCTION_ROOM ) - ({ find_object( FUNCTION_ROOM ) });
   foreach ( thing in things ) {
      if ( (string)thing->query_marker() == word )
        return file_name( thing );
   }
   thing = clone_object( FUNCTION_ROOM );
   thing->set_marker( word );
   return file_name( thing );
}
string *query_functions() {
   string *functions_found, key, *value;
   functions_found = ({ });
   foreach ( key, value in functions ) {
      functions_found -= value;
      functions_found += value;
   }
   return sort_array( functions_found, 1 );
}
string *query_rooms_with_function( string word ) {
   string *rooms_found, key, *value;
   rooms_found = ({ });
   foreach ( key, value in functions ) {
      if ( member_array( word, value ) != -1 )
        rooms_found += ({ key });
   }
   return uniq_array(rooms_found);
}

==================================================
FILE: learning/newbie/introduction/examples/.advanced_item_4.food_virtual_.c
==================================================

#include <virtual.h>
void dest_me() { destruct( this_object() ); }
void create()
{
  seteuid( (string)"/secure/master"->creator_file( file_name( this_object() ) ) );
}
object create_virtual_ob() {
   object clone;
  clone = (object)SERVER->create_virtual_object( "/obj/food.c", 1 );
  clone->add_property( "virtual name", "/d/learning/newbie/introduction/examples/advanced_item_4.food#1" );
  call_other( clone, "set_name", "sandwich"  );
  call_other( clone, "set_short", "monkey sandwich"  );
  call_other( clone, "add_adjective", ({ "monkey" })  );
  call_other( clone, "set_value", 0  );
  call_other( clone, "set_weight", 1  );
  call_other( clone, "set_long", "This is a monkey sandwich.  Made from real monkey.  Mmm!\n"  );
  call_other( clone, "add_eat_effect",  "/std/effects/ingested/poison", 600 );
   return clone;
}

==================================================
FILE: learning/newbie/introduction/examples/.simple_object.clo_virtual_.c
==================================================

#include <virtual.h>
void dest_me() { destruct( this_object() ); }
void create()
{
  seteuid( (string)"/secure/master"->creator_file( file_name( this_object() ) ) );
}
object create_virtual_ob() {
   object clone;
  clone = (object)SERVER->create_virtual_object( "/obj/clothing.c", 1 );
  clone->add_property( "virtual name", "/d/learning/newbie/introduction/examples/simple_object.clo#1" );
  call_other( clone, "set_name",  "dungarees"  );
  call_other( clone, "set_short",  "pair of waterproof dungarees"  );
  call_other( clone, "set_long",  "This is a pair of waterproof dungarees.  Luckily they "     "are also ooze proof.\n"  );
  call_other( clone, "add_adjective",  ({"pair of", "waterproof"})  );
  call_other( clone, "set_weight",  45  );
  call_other( clone, "set_value",  4000  );
  call_other( clone, "setup_clothing",  50000  );
  call_other( clone, "set_type",  "robe" );
   return clone;
}

==================================================
FILE: learning/newbie/introduction/examples/.simple_weapon.wep_virtual_.c
==================================================

#include <virtual.h>
void dest_me() { destruct( this_object() ); }
void create()
{
  seteuid( (string)"/secure/master"->creator_file( file_name( this_object() ) ) );
}
object create_virtual_ob() {
   object clone;
  clone = (object)SERVER->create_virtual_object( "/obj/weapon.c", 1 );
  clone->add_property( "virtual name", "/d/learning/newbie/introduction/examples/simple_weapon.wep#1" );
  call_other( clone, "set_name",  "mop"  );
  call_other( clone, "set_short",  "dirty mop"  );
  call_other( clone, "set_long",  "This is a dirty mop, dripping with ooze.\n"  );
  call_other( clone, "add_adjective",  "dirty"  );
  call_other( clone, "set_weight",  20  );
  call_other( clone, "set_value",  2000  );
  call_other( clone, "new_weapon", 10000  );
  call_other( clone, "add_attack",  "prod", 50, ({ 5, 6, 6 }), "blunt", "blunt", 0  );
  call_other( clone, "add_attack",  "whack", 50, ({ 10, 10, 5 }), "blunt", "blunt", 0 );
   return clone;
}

==================================================
FILE: learning/newbie/introduction/examples/advanced_item_1.c
==================================================

inherit "/obj/baggage";
void setup() {
    set_name("bag");
    set_short("little green bag");
    set_long("This is a little green bag.\n");
    add_adjective(({"little", "green"}));
    set_weight(5);
    set_max_weight(20);
}
int test_add(object ob, int flag) {
    if(this_player()->query_name() != "drakkos") {
        return 0;
    }
    else {
        return ::test_add(ob, flag);
    }
}
int test_remove(object ob, int flag, mixed dest) {
    if(this_player()->query_name() != "drakkos") {
        return 0;
    }
    else {
        return ::test_remove(ob, flag, dest);
    }
}

==================================================
FILE: learning/newbie/introduction/examples/advanced_item_2.c
==================================================

inherit "/obj/clothing";
void setup() {
    set_name("trousers");
    set_short("pair of flourescent pink flared trousers");
    add_adjective(({"pair of", "flourescent", "pink", "flared"}));
    set_long("This is a pair of extremely stylish, extremely "
    "tasteful, flourescent pink flared trousers.\n");
    set_weight(10);
    set_value(0);
    set_type("trousers");
    add_alias("flares");
    set_main_plural("pairs of flourescent pink flared trousers");
    add_plural("trousers");
    setup_clothing(10000);
    add_pocket("left", 20);
    add_pocket("right", 20);
    set_wear_remove_func(base_name(this_object()), "do_wear_stuff");
}
void do_wear_stuff(object ob) {
    if(this_player()->query_name() != "drakkos") {
        if(!ob) {
            tell_object(this_player(), "You heave a sigh of relief as "
                "you remove the ghastly garment.\n");
        }
        else {
            tell_object(this_player(), "Ye gods, are you really going "
            "to wear those hideous things?!\n");
        }
    }
    else {
        if(!ob) {
            tell_object(this_player(), "Awww, why are you taking off your "
                "super-cool slacks?\n");
        }
        else {
            tell_object(this_player(), "You feel Real Cool as you slip "
                "into your fabulous flares!\n");
        }
    }
}

==================================================
FILE: learning/newbie/introduction/examples/advanced_item_3.c
==================================================

inherit "/obj/weapon";
void setup() {
    set_name("ruler");
    set_short("wooden ruler");
    add_adjective("wooden");
    set_long("This is a thick, wooden ruler, with the inches "
        "inked out in black.\n");
    set_weight(1);
    set_value(0);
    new_weapon(5000);
    add_attack("rap", 50,({ 25, 10, 5 }), "blunt", "blunt", "do_shame");
    add_attack_message( "rap", "blunt",
   ({
    0,({ "You rap $hcname$ smartly across the knuckles with your "
        "ruler.\n",
        "$mcname$ raps you smartly across the knuckles with $mposs$ "
            "ruler.\n",
        "$mcname$ raps $hcname$ smartly across the knuckles with "
            "$mposs$ ruler.\n"})
    }));
    set_wield_func( "test_creator", base_name( this_object() ) );
}
int test_creator(object ob)  {
    if(!ob) {
        return 1;
    }
    if(ob->query_corpse()) {
        return 1;
    }
    if(ob->query_creator()) {
        tell_object(ob, "You have been deemed worthy, leetle creator!\n");
        return 1;
    }
    else {
        tell_object(ob, "You have been deemed unworthy, leetle player!\n");
        return 0;
    }
}
void do_shame( int damage, object attack_ob, object attack_by, string
    type, string name ) {
    tell_object(attack_ob, "Your knuckles %^BOLD%^sting!%^RESET%^\n");
    tell_object(attack_by, "You feel strangely satisfied as " +
        attack_ob->one_short() + " whimpers in pain!\n");
}

==================================================
FILE: learning/newbie/introduction/examples/advanced_npc.c
==================================================

#include <armoury.h>
inherit "/obj/monster";
void do_bunny(object, object);
void do_maintain(object, object);
void setup() {
    set_name("gnome");
    set_short("laughing gnome");
    set_long("This is a little, friendly looking gnome.  Well... "
        "friendly looking aside from the vicious sharp teefs and the "
        "wicked razor-like claws.  He has laughter lines all over "
        "his face, tho', so he can't be all bad.\n");
    add_property("unique", 1);
    basic_setup("gnome", "wizard", 50);
    set_gender("male");
    set_int(23);
    set_str(18);
    set_wis(18);
    add_skill_level("magic", 100);
    add_skill_level("fighting", 50);
    load_chat(20,({
        1, "' Ha ha ha!.",
        1, "' He he he!.",
        2 , "' I'm the laughing gnome, and you can't catch me!",
        1 , "#charm_women",
    }) );
    load_a_chat(20,({
        2, ": bares his teeth.",
        1, "' I'll get my brother Fred onto you!.",
        2 , "' I'll call out the Gnome Guard!",
    }) );
    add_spell("bunnies", "/obj/spells/fire_bunny", "cast_spell");
    add_spell("flowers", "/obj/spells/flowers", "cast_spell");
    add_spell("shield", "/obj/spells/small_shield", "cast_spell");
    add_combat_action(25, "bunny_them",(: do_bunny :));
    add_combat_action(25, "maintain_me",(: do_maintain :));
    add_attack( "claws", 88,({ 10, 8, 20 }), "sharp", "sharp", 0 );
    add_attack( "teeth", 88,({ 5, 5, 25 }), "pierce", "pierce", 0 );
    add_attack_message( "claws", "sharp",
   ({
    100,
       ({ "You slice $hcname$ with your claws.\n",
            "$mcname$ slices you with $mposs$ claws.\n",
            "$mcname$ slices $hcname$ with $mposs$ claws.\n"}),
    200,
       ({ "You rip $hcname$ apart with your claws.\n",
            "$mcname$ rips you apart with $mposs$ claws.\n",
            "$mcname$ rips $hcname$ apart with $mposs$ claws.\n"}),
    0,
       ({ "You scratch $hcname$ viciously with your claws.\n",
            "$mcname$ scratches you viciously with $mposs$ claws.\n",
            "$mcname$ scratches $hcname$ viciously with $mposs$ claws.\n"})
    }));
    add_attack_message( "teeth", "pierce",
   ({
    100,
       ({ "You nibble $hcname$ with your teeth.\n",
            "$mcname$ nibbles you with $mposs$ teeth.\n",
            "$mcname$ nibbles $hcname$ with $mposs$ teeth.\n"}),
    200,
       ({ "You chew on $hcname$ with your teeth.\n",
            "$mcname$ chews on you with $mposs$ teeth.\n",
            "$mcname$ chews on $hcname$ with $mposs$ teeth.\n"}),
    0,
       ({ "You sink your teeth into $hcname$.\n",
            "$mcname$ sinks $mposs$ teeth into you.\n",
            "$mcname$ sinks $mposs$ teeth into $hcname$.\n"})
    }));
}
void charm_women() {
    object player;
    foreach(player in all_inventory(environment(this_object()))) {
        if(interactive(player) && player->query_gender() == 2) {
            queue_command("cast flowers");
            queue_command("give flowers to " + player->query_name());
            queue_command("bow with a flourish");
            return;
        }
    }
}
void do_bunny(object attacker, object target) {
    object carrot,torch;
    if(target != this_object() ) {
        if(!sizeof(match_objects_for_existence("carrot", this_object()))) {
            carrot =ARMOURY->request_item ("carrot");
            carrot->move(this_object());
        }
        if(!sizeof(match_objects_for_existence("torch", this_object()))) {
            torch = ARMOURY->request_item ("torch");
            torch->move(this_object());
        }
        do_command("cast bunnies on " + target->query_name());
    }
}
void do_maintain(object attacker, object target) {
    object temp;
    if(!sizeof(match_objects_for_existence("shields", this_object()))) {
        temp = ARMOURY->request_item("wooden djelian shield", 100);
        temp->move(this_object());
    }
    do_command("cast shield on " + this_object()->query_name());
}
void adjust_hp(int number) {
    return;
}

==================================================
FILE: learning/newbie/introduction/examples/advanced_room_1.c
==================================================

#include "path.h"
inherit "/std/outside";
void setup() {
    set_short("market square");
    set_day_long("This is a lovely market square, where people mill about "
        "doing the kind of things you would expect people to do in a lovely "
        "market square.  Brightly coloured stalls stand in the corners of "
        "the market.  They seem to do good business judging by the steady "
        "stream of consumers ducking under the flaps.\n");
    set_night_long("The darkness settles on this market square like a thick "
        "black blanket.  The stalls, undoubtedly merry and brightly coloured "
        "during the day, lie dormant and unusued.  The silence is "
        "deafening.\n");
    add_property("climate",({20, 20, 10}));
    set_light(80);
    add_zone("my rooms");
    set_linker(({PATH + "advanced_room_2", PATH + "advanced_room_3"}),
        "onto", "on", "the newbie creator marketplace");
    add_day_item(({"people", "consumers"}), "The people mill around happily, "
        "browsing the goods and talking with the stallowners.");
    add_night_item(({"people", "consumers"}), "They're all tucked up in "
        "bed.  Only crazed retrobrates like you are awake at this time of "
        "night.");
    add_day_item("stall", "The stalls are brightly coloured and really "
        "quite merry.");
    add_night_item("stall", "The stalls lie dormant in the night.  Creepy!");
    room_day_chat(({120,240,({
        "People mill around happily.",
        "The brightly coloured stalls attract the eye.",
    })}));
    room_night_chat(({120,240,({
        "The only sound is the chirping of the crickets.",
        "The stalls loom ominously in the darkness.",
    })}));
    add_exit("north", PATH + "advanced_room_3", "road");
    add_exit("south", PATH + "advanced_room_2", "road");
    add_exit("east", "/w/drakkos/workroom", "road");
    add_exit("west", PATH + "simple_room", "road");
    modify_exit("east",({"look", "You get the feeling that peeking into a "
        "creator's workroom is very rude!", "function", "test_creator"}));
}
int do_search(string str) {
    if(!sizeof(str)) {
        return -1;
    }
    if(str == "shards") {
        tell_object(this_player(), "You search through the shards, but "
            "succeed only in cutting your hand slightly.  Ouch!\n");
        this_player()->adjust_hp(-100);
        if(this_player()->query_hp() < 0) {
            this_player()->attack_by(this_object());
        }
    return 1;
    }
    else {
        notify_fail("Try searching something else, perhaps?\n");
        return 0;
    }
}
string query_death_reason() {
    return "a nasty cut in the newbie creator tutorial room";
}
int test_creator(string str, object ob, string special_mess) {
    if(!ob->query_creator()) {
        notify_fail ("");
        tell_object (ob, "You are not a creator!  You may not pass!\n");
        return 0;
    }
    else {
        tell_object(ob, "You feel a tingle down your spine as you take the "
            "exit.\n");
        return 1;
    }
}

==================================================
FILE: learning/newbie/introduction/examples/advanced_room_2.c
==================================================

#include "path.h"
inherit "/std/outside";
void setup() {
    set_short("road to the market");
    add_property("determinate", "the ");
    set_day_long("This is a quiet road.  Absolutely nothing of interest is "
        "here..\n");
    set_night_long("This is a quiet road.  But at night!.\n");
    set_linker(({PATH + "advanced_room_1", PATH + "advanced_room_3"}),
        "onto", "on", "the newbie creator marketplace");
    set_light(80);
    add_zone("my rooms");
    add_item("road", "I *said*, there's nothing interesting at all here.");
    add_exit("north", PATH + "advanced_room_1", "road");
}

==================================================
FILE: learning/newbie/introduction/examples/advanced_room_3.c
==================================================

#include "path.h"
inherit "/std/outside";
void setup() {
    set_short("road to the market");
    add_property("determinate", "the ");
    set_day_long("This is a quiet road.  Absolutely nothing of interest is "
        "here..\n");
    set_night_long("This is a quiet road.  But at night!.\n");
    set_linker(({PATH + "advanced_room_1", PATH + "advanced_room_2"}),
        "onto", "on", "the newbie creator marketplace");
    set_light(80);
    add_zone("my rooms");
    add_item("road", "I *said*, there's nothing interesting at all here.");
    add_exit("south", PATH + "advanced_room_1", "road");
}

==================================================
FILE: learning/newbie/introduction/examples/simple_npc.c
==================================================

inherit "/obj/monster";
void setup() {
  set_name("blob");
  set_short("grey blob");
  set_long("This is a grey blob.  It is grey.  It is also quite "
      "blobby.\n");
  basic_setup("human", "warrior", 10);
  set_gender("male");
  add_adjective(({"oozing", "grey"}));
  set_main_plural("grey blobses");
  add_alias("porridge");
  add_respond_to_with(({ "@say",({"blob", "grey"}),
      }), "say Yes, I am a grey blob.");
  add_respond_to_with(({ "@say",({"ooze", "blue", "cardboard"}),
     ({"porridge", "bing", "womble"}),
      }), "' Yes, I'm oozing quite nicely, like grey "
          "blobs do.  Like porridge!");
  add_respond_to_with(({ "@thank", ({ "you", "blob" }) }),
      "' Aw, shucks. T'weren't nuthin'.");
  add_respond_to_with(({ ({"@gnaw", "@bite", "@chew"}), ({ "you",
    "blob" }) }),
      ({"' What did you do that for?!",  "scream", "cry", "weep"}));
  load_chat(20,({ 2, ": oozes around.",
      1, "' I'm very grey.",
      2 , "' I'm a blob.",
      2 , "@bing",
  }) );
  load_a_chat(20,({ 2, ": oozes all over you.",
      1, "' Lemme alone!.",
      2 , ": sobs bitter, slimy tears.",
  }) );
}

==================================================
FILE: learning/newbie/introduction/examples/simple_object.c
==================================================

inherit "/obj/clothing";
void setup() {
    set_name("dungarees");
    set_short("pair of waterproof dungarees");
    add_adjective(({"pair of", "waterproof"}));
    set_long("This is a pair of waterproof dungarees.  Luckily they "
        "are also ooze proof.\n");
    add_adjective(({"pair of", "waterproof"}));
    set_weight(45);
    set_value(4000);
    setup_clothing(50000);
    set_type("robe");
}

==================================================
FILE: learning/newbie/introduction/examples/simple_room.c
==================================================

#include "path.h"
inherit "/std/room";
void setup() {
    set_short("blobby lair");
    set_long("This is where the grey blob lives.  All around lie "
        "frogs, and wombles, and strange oozy things.  It's a "
        "very nice lair, as lairs go.\n");
    add_property("determinate", "a ");
    set_light(50);
    add_item(({"frog", "pinkfish", "toad"}),({"long", "The frogs are very "
        "nice.  Very froggy.", "position", "one of the poor leetle "
        "frogs."}));
    add_item(({"womble", "uncle bulgaria"}),({"long", "It's Uncle "
        "Bulgaria!", "pet", "You pet Uncle Bulgaria.  He growls and "
        "chews the nails off your hand.\n", "snuggle", "Uncle Bulgaria gnaws "
        "on your teeth.\n"}));
    add_item("strange oozy things", "Ewww!");
    add_zone("my rooms");
    add_sign("This is a nice sign.\n", "Do Notte Feed Thee Blob!",
        "nice sign", "sign", "common");
    room_chat(({120,240,({
        "A thick blob of goo oozes over one of the frogs.",
        "The womble bings quietly.",
        "The frogs ribbit in abstract contemplation.",
    })}));
    add_exit("east", PATH + "advanced_room_1", "road");
}
void reset() {
    call_out("after_reset", 3);
}
void after_reset() {
    object ob = find_object
        (PATH + "simple_npc");
    if(!ob) {
        ob=load_object(PATH + "simple_npc");
        ob->move(this_object(), "$N appear$s with a wet squelch.\n");
    }
    else if(!environment(ob)) {
        ob->move(this_object(), "$N appear$s with a wet squelch.\n");
    }
}

==================================================
FILE: learning/items/matcher.c
==================================================

inherit "/std/object";
#define CMD 0
#define PAT 1
void add_cmds( object player );
int do_add( string command, string pattern );
int do_remove( int i );
int do_match( object *indirect_obs, string dir_match,
    string *indirect_match, mixed args, string pattern );
string read_msg();
string *cmds = ({});
void setup() {
  set_name( "matcher" );
  set_short( "Tannah's pattern matcher" );
  add_property( "determinate", "" );
  add_alias( "pattern matcher" );
  set_long(
    "This is a very handy wossname, useful for testing patterns you "
    "might like to use in an add_command.\n"
  );
  add_adjective( ({ "handy", "patterned" }) );
  set_weight( 1 );
  set_value( 0 );
  add_property( "no recycling", 1 );
}
void init() {
  add_cmds( this_player() );
}
void add_cmds( object player ) {
  set_read_mess( (: read_msg :) );
  player->add_command( "add", this_object(), "command <word'command'> "
      "with pattern <string:quoted'pattern'>",
      (: do_add( $4[0], $4[1] ) :) );
  player->add_command( "remove", this_object(), "command <number>",
      (: do_remove( $4[0] ) :) );
  if( sizeof( cmds ) ) {
    for( int i = 0; i < sizeof( cmds ); i++ )
      player->add_command( cmds[i][CMD], this_object(), cmds[i][PAT],
          (: do_match :) );
  }
}
int do_add( string command, string pattern ) {
  cmds += ({ ({ command, pattern }) });
  this_player()->remove_object( this_object(), 1 );
  add_cmds( this_player() );
  printf( "You add the command \"%s\" with the pattern \"%s\" to the "
      "pattern matcher.\n", command, pattern );
  return 1;
}
int do_remove( int i ) {
  if( i >= sizeof( cmds ) || i < 0 ) {
    printf( "Invalid command number.\n" );
    return 0;
  }
  printf( "You remove the command \"%s\" with the pattern \"%s\" from "
      "the pattern matcher.\n", cmds[i][CMD], cmds[i][PAT] );
  cmds = cmds[0..i-1] + cmds[i+1..];
  this_player()->remove_object( this_object(), 1 );
  add_cmds( this_player() );
  return 1;
}
int do_match( object *indirect_obs, string dir_match,
    string *indirect_match, mixed args, string pattern ) {
  printf( "Indirect objects: %O\n", indirect_obs );
  printf( "Direct match: %s\n", dir_match );
  printf( "Indirect match: %O\n", indirect_match );
  printf( "Args: %O\n", args );
  printf( "Pattern: \"%s\"\n", pattern );
  return 1;
}
string read_msg() {
  int i;
  string msg;
  msg = "The pattern matcher is currently set to test the following "
        "commands and patterns:\n";
  if( !sizeof( cmds ) ) msg += "  None.\n";
  else for( i = 0; i < sizeof( cmds ); i++ ) {
    msg += sprintf( "[%d] \"%s\", \"%s\"\n", i, cmds[i][CMD],
           cmds[i][PAT] );
  }
  msg += "See 'syntax add' and 'syntax remove' to modify the list.";
  return msg;
  msg += "For further [nearly accurate] information on add_command, "
    "see the files in /w/tannah/learning/add_cmd.\n";
}
void list_cmds() {
  printf( "Commands and patterns added:\n%O\n", cmds );
}

==================================================
FILE: learning/chars/npc_example.c
==================================================

inherit "/obj/monster";
#include <armoury.h>
object comb;
void setup() {
   set_name( "ralph" );
   set_short( "Ralph the spotted giraffe" );
   add_property( "determinate", "" );
   add_adjective( "spotted" );
   set_main_plural("Ralph the spotted giraffes");
   add_plural(( { "ralphs", "giraffes" } ));
   add_alias(( { "giraffe", "Ralph" } ));
   set_long( "This is Ralph the spotted giraffe.  He is just an example in "
             "this file so I won't describe him although I should.  Well, "
             "okay then... He's like any normal giraffe except for his cool "
             "black specs and mop fringe.  He is coolnes personified.\n" );
   add_property( "unique", 1 );
   set_race( "horse" );
   set_guild("wizard");
   set_height( 300 );
   set_weight( 1600 );
   set_gender( 1 );
   set_al( -500 );
     set_level( 15 );
   set_con(18);
   set_dex(18);
   set_str(16);
   set_wis(15);
   set_int(15);
   add_move_zone( "Short" );
   add_move_zone( "Filigree" );
   set_move_after( 50, 60 );
   set_virtual_move(1);
   load_chat( 90, ({
      3, "@grin",
      3, "@high5 $lname$",
      2, "@bless $lname$",
      1, "@moonwalk",
      1, "'Far out man.",
      1, ({
         "'Hey, if it isn't $lname$!",
         "'You're looking cool as usual!"
      }),
      1, ":tells you: Hey my man!  Watcha up to?",
      1, "'That's cool.",
      1, "'Chillin' out here, are we?",
      1, "@ruffle $lname$",
      1, "@wink $lname$",
      2, ":does a really complicated tap dance manoeuvre.",
      1, "'Let's do something wild and crazy...",
      1, ({
         "'Yoho, how's it hangin'?",
         "'I'm in a darn good mood today!"
      }),
      1, ":tells you: Ouch man, where the heck did you find those clothes?"
   }) );
   load_a_chat( 100, ({
     1, "'Wait till Hobbes hears about this!",
     1, "'It's SO uncool to fight!",
     1, "@scream",
     1, "You can't believe you're fighting such a nice creature as Ralph.",
     1, ":seems to wish he was somewhere else."
     }) );
   ARMOURY->request_weapon("meat cleaver", 80+random(20))->move(this_object());
   ARMOURY->request_armour("gigantic dog collar", 100)->move(this_object());
   ARMOURY->request_armour("straw hat", 80)->move(this_object());
   comb=clone_object("/d/am/items/comb");
   comb->move( this_object() );
   init_equip();
}

==================================================
FILE: learning/chars/terrain_teacher.c
==================================================

#include <armoury.h>
#include "path.h"
inherit "/obj/monster";
#define TERRAIN_CONTROL "/d/admin/room/terrain"
#define PROPERTY "terrain lesson stage"
#define CROSS_IMPATIENCE 100
#define TAPS_IMPATIENCE 200
#define MAX_IMPATIENCE 300
#define COSTUME_NORMAL 0
#define COSTUME_DESERT 1
#define COSTUME_WET 2
#define COSTUME_COLD 3
int costume_normal();
int costume_desert();
int costume_wet();
int costume_cold();
protected void to_terrain();
protected void from_terrain(string to);
object hq;
object pupil;
int impatience;
int costume;
int lesson_step;
int speeching;
mixed *lessons =
({
   ({ "grassyfield", COSTUME_NORMAL,
      ({
         "emote sniffs the air.",
         "smile",
         "'This is a very simple terrain.  Take a little time to look around "
            "at it, wander around, read some of the code.  There isn't a whole "
            "lot to it.  When you feel you know what's here, come back and tell "
            "me you're ready.  I'll wait until you say \"ok\" or "
            "\"ready\" where I can hear you.  If you accidentally wander back to "
            "the foyer, type 'grassyfield' to return here.",
         0,
         "'You should have noticed that there are two different rooms in this "
            "area: the room in which we stand now, with this quaint cottage "
            "behind me, and the rooms of the field.",
         "'All the rooms are very simple.  You should have read the code for "
            "them.  If you haven't, do it now.  I'll wait until you're ready.",
         0,
         "'I assume that you have written rooms, both indoors and outdoors, "
            "before.  You should have noticed two strange features to the files "
            "that make up this area: first that they both have a call to a "
            "function called set_terrain(), and second that they both are "
            "remarkably lacking in add_exit() calls!",
         "'In fact, excepting this one 'cottage' exit behind me, the files "
            "have no exits at all.  Nevertheless, you were able to walk around "
            "quite freely.",
         "'That is the primary purpose to the terrain handler: it manages your "
            "exits for you.",
         "'The call to set_terrain(), then is simply the means by which you "
            "can tell the terrain handler that it needs to manage this room.",
         0,
         "'There are two types of rooms that the terrain handler can manage: "
            "fixed rooms and floating rooms.  The code for both looks the same, "
            "but the terrain handler treats them very differently.",
         "'In order for the terrain handler to know how to handle each room, "
            "you have to tell it.  That's done in the terrain handler control "
            "room: /d/admin/room/terrain.  You can get there from the commonroom "
            "by walking one east then one southeast.  Personally, I prefer to "
            "use an alias.",
         "'We'll go to the terrain control room in a moment, so you can see "
            "how to use it.  For the moment, suffice to say that every room "
            "that has a call to set_terrain() also needs to be registered in "
            "the terrain control room.",
         0,
         "'In this terrain, we have the doorstep (a fixed room) and all the "
            "rooms of the field (floating).  The primary difference between "
            "floating and fixed rooms is that you can only have one of each "
            "fixed room in a terrain, but you can have any number of floating "
            "rooms.",
         "'In fact, you probably noticed that this area is a 3x3 grid.  We're "
            "in the center of the southern edge of that grid right now, at the "
            "doorstep.",
         "'When I created this terrain, I just said that the field should "
            "cover the entire 3x3 area.  Then I plopped the fixed room down here, "
            "and it automatically took the place of the field room that would "
            "have been here.",
         "'This is an important concept: floating rooms cover predefined "
            "regions, while fixed rooms are in one place.  When a particular "
            "location is in the region of a floating room _and_ is the location "
            "of a fixed room, the fixed room wins.",
         "'This makes it so you can define huge sweeping areas of the floating "
            "rooms, and just plop down your fixed rooms in strategic areas.",
         0,
         "'Now, when I say 'location', what I'm referring to is the coordinates "
            "of the room.  As a creator, you can look at a room, and the "
            "coordinates (or \"unset\") appear just before the description.  "
            "As you work on terrains, you'll find yourself looking at those "
            "coordinates a lot.",
         "'Walk around a bit, and see how the coordinates change as you move "
            "in the different directions.  You will see the first number "
            "increase when you walk north, and decrease when you walk south.  "
            "The second increases when you walk east, and the third increases "
            "whenever you go up.",
         "'So that's ( north, east, up ).",
         0,
         "'Ok, let's show you the terrain control room now.",
         (: this_object()->to_terrain() :),
         "'Ok, here we are in the terrain control room.",
         "'Feel free to look at the room here before I explain everything "
            "to you.  Well, not quite everything: that green box is an advanced "
            "device for a later lesson.",
         0,
         "'The first thing you need to do before using the terrain room is "
            "always, always, always, set the terrain name.  Do that with the "
            "\"terrain\" command.",
         "'Type \"terrain tutorial_grassy_field\".  Be very careful about "
            "the spelling, you have to get it exactly right.",
         "'If you're worried, just type \"terrain\" and the room will "
            "show you the current terrain",
         0,
         "'Now that you've set the terrain, you can list the rooms that I "
            "have set here.  Use \"list floating\" to see all the floating "
            "rooms, and \"list fixed\" to see all the fixed rooms.",
         "'As I've mentioned before, this terrain only has one fixed and "
            "one floating room.",
         0,
         "'When it lists the floating room, it tells you the name of the "
            "file, the coordinates of two opposite corners of the region, and "
            "one final number.  That last number is a priority.  We'll talk "
            "about that in the second lesson.  For now, ignore it.",
         "'In this terrain, we have the field room in the whole area where "
            "the first coordinate is between -100 and 100 (inclusive), the "
            "second coordinate is between -100 and 100 (inclusive), and "
            "the third coordinate is equal to 800000.",
         "'The only reason for that strange third coordinate was that I wanted "
            "to keep these rooms far away from the player areas.",
         "shrug",
         "'That number before the file name is just an index in the list of "
            "floating rooms.  Since we only have one floating room, it isn't "
            "very useful to us.",
         0,
         "'Both of our rooms inherit /std/room/outside.  That makes the rooms 100 "
            "units wide in each direction.  So in that range of coordinates, we "
            "can have 3 rooms: -100, 0, and 100 for each of the first two "
            "coordinates.  So the whole terrain is a 3x3 block.",
         0,
         "'Now looking at the fixed room, it gives you the name of the file "
            "and _one_ set of coordinates.  That's it.  There's only the one set "
            "of coordinates, because each fixed room can only be in one location.",
         "'If you try to add another fixed room with the same file, the "
            "terrain control room will gripe at you and refuse to do it.  You'll "
            "have to remove the old room first.  You do that with the \"remove\" "
            "command, but we'll get to that later.",
         0,
         "'Notice that the fixed room is at (-100, 0, 800000).  That is inside "
            "the range of coordinates that we have set for the floating rooms: "
            "the first and second coordinates are between -100 and 100, and the "
            "last coordinate is 800000.  But this is a fixed room, so it wins the "
            "fight for that location.",
         "'This is what I was talking about earlier, when I mentioned putting "
            "the doorstep in the middle of the southern edge of the square: -100 "
            "is the southernmost edge of the square, while 0 is in the middle of "
            "that edge.",
         0,
         (: this_object()->from_terrain(TERRAIN_TUTORIAL "grassystep") :),
         "'And here we are back at the field.",
         "'That's it for the basic terrain lesson.  Wander around a bit more "
            "to look at the things I have mentioned, and come back here when "
            "you're ready to finish this lesson up.",
         "'There are more lessons available to you, so if you're up to it, "
            "talk to me when we get back to the foyer, and I'll continue to teach "
            "you.",
         "smile",
         "'You've been an excellent pupil.",
         0,
         "'Good",
      }),
      "cottage"
   }),
   ({ "desert", COSTUME_DESERT,
      ({
         "stretch",
         "emote starts to sweat",
         "'Ah, the desert!",
         "'As in the field, take a moment to wander around here.  Use what you "
            "learned in the first lesson, and look a bit more closely at the rooms "
            "in this area.",
         0,
         "'You should have noticed that there are three different areas in this "
            "terrain: this spot here next to the tent, the desert, and an oasis.  "
            "If you didn't notice, look at it now.",
         0,
         "'Once again, we have a largely square area, this time 6 squares east "
            "and west, and 5 squares north and south.  As you might have guessed, "
            "I created this area by covering the whole square with the desert "
            "room, and then plopped down this room in the corner.  But the oasis "
            "squares are interesting.  Let's go to the terrain control room and "
            "see.",
         (: this_object()->to_terrain() :),
         0,
         "'Ok, set the terrain to \"tutorial_desert\".  If you've forgotten, "
            "that's \"terrain tutorial_desert\".",
         "'When you've done that, list the floating rooms to see some nifty "
            "stuff.",
         0,
         "'Notice how I've got two rooms here: sanddunes and sandoasis.",
         "'Look carefully at the coordinates for the rooms, and you'll see that "
            "the sandoasis rooms overlap the sanddunes rooms.\n",
         "'The important difference is that last number.  Sanddunes says that "
            "it is \"level 0\", while sandoasis says it is \"level 1\".",
         "'The level is a kind of priority: when two or more floating rooms are "
            "at the same coordinates, the one with the highest level wins, and "
            "will be the room that the terrain handler actually puts down.",
         "'So in this terrain, the far northwest corner (that's at "
            "200, 1000, 800000) is in both the sanddunes and the sandoasis "
            "areas.  But since sandoasis has a higher level, that location "
            "is an oasis.",
         0,
         "'This little wrinkle lets you overlay lots of different rooms, "
            "stacking them up, to get very complex shapes without having to "
            "plop down rooms one by one.",
         "'For example, suppose one room covers (-200, -200, 0) to "
            "(200, 200, 0), at level 0.  Then we put a second room from "
            "(-100, -100, 0) to (100, 100, 0) at level 1.  The first room "
            "makes a 5 by 5 ring around the second area, which is 3 by 3.",
         "'We can make that more complex by putting more of the first "
            "room down, from (0, 0, 0) to (0, 100, 0) at level 2.  Now the "
            "center area, instead of being a 3 by 3 square, is a kind of "
            "'C' shape.  It might be helpful to draw that out on a piece "
            "of graph paper, so you can see it better.",
         0,
         "'Using these levels, you can even make it so that a terrain has "
            "holes in it.  That's convenient when you want to force people "
            "to walk around something.  Just add a floating room with a high "
            "level, and use the special file name \"nothing\".",
         0,
         "'Well, that's it for this lesson.",
         (: this_object()->from_terrain(TERRAIN_TUTORIAL "sandtent") :),
         "'Come back again, and we'll talk about some of the pitfalls "
            "involved in designing terrains.",
         0,
      }),
      "tent"
   }),
   ({ "mountaintop", COSTUME_COLD,
      ({ "rub hands",
         "shiver",
         "'Sorry about the cold, I never got around to putting a door on "
            "this cabin.",
         "frown",
         "shrug",
         "'Oh well.",
         "'This time, I don't want you to wander freely around the terrain: "
            "it's much more complex than the others you've explored, and I want "
            "to do this one one step at a time.",
         0,
         "'This room right here is a fixed room.  We have one more fixed room "
            "upstairs, and both are connected by the staircase behind me.  That "
            "exit was added automatically by the terrain handler, just as in "
            "the case of floating rooms, but here we have two fixed rooms whose "
            "exits are being managed.",
         "'We'll go to the terrain control room in a moment, but first I want "
            "to show you a few things.",
         "'Look at the coordinates for this room.  If you didn't see the "
            "coordinates when you came in to this room, 'look' now.",
         0,
         "up",
         "'Now compare the coordinates of this room to the room we were just "
            "in.",
         0,
         "'Previously, whenever you moved from one room to another, the "
            "coordinates changed by 100.  This time, they only changed by 20.",
         "'Previously, all our rooms were 100 units across.  These two "
            "rooms, however, are only 20.  That's because our previous rooms "
            "all inherited /std/room/outside, while these two cabin rooms inherit "
            "/std/room/basic_room.  The code assumes that indoor rooms tend to be smaller "
            "than the great outdoors.",
         "'One side effect of that is that you have to be careful when "
            "lining up rooms in the terrain control room.  Be sure to check "
            "that the positions you give your rooms line up right, so the "
            "terrain handler can generate the correct exits.",
         "'In this case, I had to make sure that I planted this attic "
            "exactly 20 units above the other room.",
         0,
         "'This gets a little bit hairy when you have an indoor room "
            "meeting an outdoor room.  Let's look at that now.",
         "down",
         "'Here's an indoor room",
         0,
         "west",
         "lsay And here's an outdoor room",
         0,
         "lsay This time the coordinates changed by 60.",
         "lsay \"60?!  Where'd 60 come from?\" I bet you ask?",
         "lsay I've already said that outside rooms are 100 units across, and "
            "indoor rooms are 20 units across.  So from the center of an outside "
            "room, the walls are all 50 units from you.  From the center of an "
            "indoor room, the walls are 10 units from you.  Normally, when you go "
            "from the center of one outdoor room to another, that's 50 units in "
            "the first room, and another 50 units in the destination room: 100 "
            "units total",
         "lsay Likewise, in an indoor room, you go 10 units in the first room, "
            "and another 10 units in the second room: 20 units total.",
         "lsay So the 60 units we just moved is 10 units in the indoor room "
            "where we started, plus another 50 units in the outdoor room where "
            "we ended up.",
         "lsay Of course, I had to take that into account in the terrain "
            "control room when I lined up these rooms.",
         0,
         "lsay Now, there's one more thing that I want to show you before "
           "we go to the terrain room.",
         "sw",
         "s",
         "lsay Here's a tree that I planted a few years ago.  We can climb "
            "it.",
         "up",
         0,
         "lsay Did you notice the change in coordinates this time?  70.",
         0,
         "lsay Now this tree that we're hanging from is an outdoor room, as "
            "you can tell by all the weather we're having.  However, it's not "
            "the usual size.",
         "lsay Do 'find -d setup() here', to read the setup function for this "
            "room.  Notice how I have a call to set_room_size() just before "
            "the call to set_terrain().  That set_room_size() controls how far "
            "the walls are from the center of the room.  So this room is twice "
            "that width: 40 units across and 40 units tall.",
         "lsay That should account for the coordinates changing by 70 when "
            "we climbed the tree: 50 as we left the lower room, and 20 coming in "
            "to this room.",
         0,
         "lsay You can change the size of any room you want this way, but "
            "make absolutely sure that you call set_room_size() _before_ "
            "you call set_terrain().  That is critically important, and all "
            "sorts of subtle bugs can happen, generally involving the wrong "
            "exits showing up, if you get that wrong.",
         "lsay Also, set_room_size() can take an array of 3 coordinates to "
            "control the size of the room separately in all three dimensions.",
         "lsay Unfortunately, the terrain handler doesn't understand that "
            "level of complexity, so don't ever do it with rooms you expect to "
            "have managed by the terrain handler.",
         0,
         "lsay ok, let's go to the terrain control room, and you can look "
            "at my work.",
         (: this_object()->to_terrain() :),
         "lsay Here we...",
         "blush",
         "' Heh.  Got so used to yelling over the wind...",
         "smile",
         "'Here we are in the terrain room.  Set the terrain to "
            "tutorial_mountain and list out the fixed rooms.",
         0,
         "'Notice the last coordinates on both.  That's what I mentioned "
            "before, that I had set the two 20 units apart.",
         "'Now list the floating rooms.",
         0,
         "'Here I've done something different.  The mountainsnows room "
            "makes a big square, 5 by 5.  In the very center of that square, "
            "there is a 'nothing' room.  You should remember from the last "
            "lesson, that when the filename of a floating room is 'nothing', "
            "the terrain handler puts no room at that location.  So here we "
            "have the floating terrain with a hole in the middle.",
         "'Inside that hole, I plopped down the cabin.  How it's not "
            "centered in that hole, it's actually to the west of the center.",
         "'That's because I needed to ensure that, with the differente "
            "sizes of the outside vs. inside rooms, things would still line up.",
         "'So when you walk out of the cabin, you walk west.  When you walk "
            "around it, the terrain handler doesn't give you any extra entrances "
            "to the cabin.",
         0,
         "'There's one extra thing I had to do to get the cabin to work right, "
            "and I'll show you that soon, but first notice the mountaintree "
            "rooms.  There shouldn't be any suprises with that, just remember "
            "that the tree rooms are a different size.",
         0,
         "'Ok, back to the cabin.",
         (: this_object()->from_terrain(TERRAIN_TUTORIAL "mountaincabin") :),
         "'Here we are, back in the ground floor of the mountain cabin.",
         "'Notice how we have 3 exits here: up, down, and west.  Obviously, "
            "there's no north, east, or south exits, because we have that "
            "'nothing' room right here.",
         "lsay Wrong!",
         "grin",
         "'That 'nothing' trick only works with floating rooms.  In order to "
            "ensure that this room doesn't have the north, east, and south exits, "
            "I had to add a special function to the room.",
         "'Type 'find -d query_exit_type() here'",
         0,
         "'In any room that is managed by the terrain handler, whether than "
            "room is a floating room or a fixed room, the terrain handler checks "
            "a function called query_exit_type() to see what type of exit it "
            "should create in each direction.",
         "'The arguments are a string for the direction of the exit (north, "
            "west, south, northeast, etc.) and a string containing the file name "
            "of the destination room.  These are both just like you would use "
            "in a call to add_exit().",
         "'The function returns a string for an exit type, just like the "
            "third argument to add_exit().",
         "'There is, of course, a wrinkle: if query_exit_type() returns "
            "\"none\", then that exit isn't created at all.",
         0,
         "'If the room doesn't have a function called query_exit_type(), "
            "then some default values are used.  Those defaults are in an array "
            "at the beginning of /obj/handlers/terrain_handler.  It's real "
            "easy to find.",
         "'There are a lot of things that can be done to modify the exits "
            "that the terrain handler builds, but that'll be the subject for the "
            "next lesson.",
         "'For now, wander around if you feel like it, and come back to me "
            "when you're ready to finish this up.",
         0,
      }),
      "down"
   }),
   ({ "grassyfield", COSTUME_NORMAL,
      ({ "laugh",
         "'In spite of dragging you out here like this, Sin hasn't actually "
            "scripted this lesson yet.  Sorry.  This would've been the fourth "
            "lesson, in which I talk about how you can modify the exits that "
            "the terrain handler makes for you.",
         "shrug",
      }),
      "cottage"
   }),
});
void setup() {
   object obj;
   object backpack;
   set_name("terrain teacher");
   add_alias("teacher");
   set_short("terrain teacher");
   add_property("determinate", "the ");
   add_property("unique", 1);
   set_long("This man is middle aged, and apparently human.  That's about "
            "all you can really see, because he's soaking wet, his hair is caked "
            "with leaves and mud, his clothes are torn, and his boots are caked "
            "with dirt.\n");
   set_race("human");
   set_guild("monk");
   set_level(50);
   set_gender(1);
   add_effect("/std/effects/other/wetness", 10000);
   set_respond_to_with( ({
      ({ "@say", "teach", "please" }), "#new_pupil",
      ({ "@say", "please", "teach" }), "#new_pupil",
      ({ "@say", "teach" }), "#new_rude_pupil",
      ({ "@say", ({ "ok", "ready" }) }), "#next_speech",
   }) );
   backpack = ARMOURY->request_item("large backpack", 80);
   if (!backpack) backpack = ARMOURY->request_item("black leather backpack", 80);
   if (!backpack) backpack = ARMOURY->request_item("small backpack", 80);
   if (backpack) backpack->move(this_object());
   obj = ARMOURY->request_item("large leather boots", 20);
   if (obj) obj->move(this_object());
   obj = ARMOURY->request_item("thermal underwear", 10);
   if (obj) obj->move(this_object());
   obj = ARMOURY->request_item("fawn cotton trousers", 50);
   if (obj) obj->move(this_object());
   obj = ARMOURY->request_item("leather belt", 50);
   if (obj) obj->move(this_object());
   obj = ARMOURY->request_item("black wool socks", 40);
   if (obj) obj->move(this_object());
   obj = ARMOURY->request_item("gaudy shirt", 35);
   if (obj) obj->move(this_object());
   obj = ARMOURY->request_item("brown felt hat", 10);
   if (obj) obj->move(this_object());
   obj = ARMOURY->request_item("white cotton toga", 80);
   if (obj) obj->move(backpack);
   obj = ARMOURY->request_item("yellow raincoat", 60);
   if (obj) obj->move(backpack);
   obj = ARMOURY->request_item("old black cloak", 72);
   if (obj) obj->move(backpack);
   obj = ARMOURY->request_item("amusing earmuffs", 100);
   if (obj) obj->move(backpack);
   init_equip();
   costume = COSTUME_NORMAL;
   hq = find_object(TERRAIN_TUTORIAL "foyer");
   impatience = 0;
   lesson_step = 0;
   speeching = 0;
}
int check_anyone_here() {
   if (pupil) return 1;
   else return ::check_anyone_here();
}
void heart_beat() {
   ::heart_beat();
   if (!pupil) return;
   ++impatience;
   if (impatience == CROSS_IMPATIENCE) {
      init_command("emote is beginning to look a bit impatient.", 1);
   } else if (impatience == TAPS_IMPATIENCE) {
      init_command("emote begins tapping his foot.", 1);
   } else if (impatience == MAX_IMPATIENCE) {
      init_command("'That's it, you clearly don't really want to learn.  "
                   "I give up on you, " + pupil->short(), 1);
      call_out("come", 3 + costume_normal(), hq);
      pupil = 0;
      impatience = 0;
   }
}
int add_follower( object who ) {
   if (who == pupil) {
      int lesson;
      impatience = 0;
      lesson = pupil->query_property(PROPERTY);
      if (lesson < 0 || lesson >= sizeof(lessons)) {
         init_command("think", 1);
         init_command("'Odd, you seem to have done more lessons than I know.", 2);
         init_command("'I'm afraid I have nothing to teach you.", 3);
         pupil->remove_property(PROPERTY);
         pupil = 0;
         return 0;
      } else if (::add_follower(who)) {
         int delay;
         switch (lessons[lesson][1]) {
          case COSTUME_NORMAL: delay = costume_normal(); break;
          case COSTUME_DESERT: delay = costume_desert(); break;
          case COSTUME_WET: delay = costume_wet(); break;
          case COSTUME_COLD: delay = costume_cold(); break;
         }
         init_command(lessons[lesson][0], delay + 2);
         lesson_step = 0;
         call_out("speech", delay + 10);
         return 1;
      } else {
         return 0;
      }
   } else {
      init_command("'For what reason do you want to follow me, " +
                   who->short() + "?  I'm not teaching you.", 0);
      return 0;
   }
}
void coming( object where ) {
   tell_room( where,
      "%^CYAN%^Someone says: One moment!  I'll be right down!%^RESET%^\n",
             ({ this_object() }) );
}
void annoyed_coming( object where ) {
  tell_room( where,
    "%^CYAN%^An annoyed someone says: I said I'm coming!  "
    "Jeez!%^RESET%^\n",
    ({ this_object() }) );
}
void come( object where ) {
   hq = where;
   if (where != environment())
      move( where, this_object()->a_short() + " arrives",
           this_object()->a_short() + " stomps away" );
   init_command( "emote looks around", 1 );
   init_command( "sigh", 4 );
   init_command( "get sign", 7 );
   init_command( "emote looks at the sign", 9 );
   init_command( "sit on bench", 10 );
   init_command( "'What can I do for you?", 12 );
}
void done() {
   int delay = costume_normal();
   int lesson;
   lesson = pupil->query_property(PROPERTY) + 1;
   if (lesson == sizeof(lessons)) {
      init_command("'congratulations, " + pupil->short() + ", you have "
                   "completed all the terrain handler lessons.", ++delay);
      pupil->remove_property(PROPERTY);
   } else
      pupil->add_property(PROPERTY, lesson);
   init_command("emote looks around", delay + 1);
   init_command("sigh", delay + 4);
   init_command("get sign", delay + 7);
   init_command("emote looks at the sign", delay + 9);
   init_command("sit on bench", delay + 10);
   pupil = 0;
   impatience = 0;
   speeching = 0;
}
void speech() {
   int lesson = pupil->query_property(PROPERTY);
   int delay;
   delay = 0;
   speeching = 1;
   if (lesson_step == sizeof(lessons[lesson][2])) {
      init_command(lessons[lesson][3], delay + 3);
      call_out("done", delay + 4);
      call_out( (: speeching = 0 :), delay + 5);
      return;
   }
   do {
      if (functionp(lessons[lesson][2][lesson_step])) {
         call_out(lessons[lesson][2][lesson_step], ++delay);
      } else if (stringp(lessons[lesson][2][lesson_step])) {
         init_command(lessons[lesson][2][lesson_step], ++delay);
      }
      if (++lesson_step == sizeof(lessons[lesson][2])) {
         init_command(lessons[lesson][3], delay + 3);
         call_out("done", delay + 4);
         call_out( (: speeching = 0 :), delay + 5);
         return;
      }
   } while (lessons[lesson][2][lesson_step]);
   lesson_step++;
   init_command("emote waits for " + pupil->a_short(), ++delay);
   call_out( (: speeching = 0 :), ++delay);
}
void pupil_arrived( object where ) {
   if (pupil) return;
   if (!environment()) {
      if (find_call_out("come") != -1)
         call_out("annoyed_coming", 0, where);
      else {
         call_out("come", 10, where);
         if (find_call_out("coming") == -1)
            call_out("coming", 2, where);
      }
   } else if (environment() == where) {
      init_command("'Oh, a pupil!", 2);
   }
}
protected void to_terrain() {
   move(TERRAIN_CONTROL, "The terrain teacher appears",
        "The terrain teacher snaps his fingers and vanishes");
   tell_object(pupil, "Something snags you through space\n");
   pupil->move_with_look(TERRAIN_CONTROL, pupil->short() + " appears",
                         pupil->short() + " looks surprised and disappears.");
}
protected void from_terrain( string to ) {
   move(to, "The terrain teacher appears",
        "The terrain teacher snaps his fingers and vanishes");
   tell_object(pupil, "Something snags you through space\n");
   pupil->move_with_look(to, pupil->short() + " appears",
                         pupil->short() + " looks surprised and disappears.");
}
protected int modesty() {
   int num;
   num = sizeof(filter_array(all_inventory(environment()),
            (: living($1) && $1->query_gender() != 1 :) ));
   if (num) {
      if (num > 1)
         init_command("'Ladies, would you please turn around for a "
                      "moment?", 1);
      else
         init_command("'Ma'am, would you please turn around for a "
                      "moment?", 1);
      return 10;
   } else return 0;
}
int costume_normal() {
   int i;
   if (costume == COSTUME_NORMAL) return 0;
   i = modesty();
   init_command("remove backpack", ++i);
   init_command("remove toga, raincoat, cloak, earmuffs", ++i);
   init_command("put toga, raincoat, cloak, earmuffs in backpack", ++i);
   init_command("get trousers, belt, shirt, hat from backpack", ++i);
   init_command("equip", ++i);
   costume = COSTUME_NORMAL;
   return i;
}
int costume_desert() {
   int i;
   if (costume == COSTUME_DESERT) return 0;
   i = modesty();
   init_command("remove backpack", ++i);
   init_command("remove raincoat, cloak, earmuffs", ++i);
   init_command("remove belt, hat, shirt", ++i);
   init_command("remove trousers", ++i);
   init_command("put trousers, belt, shirt, hat, raincoat, cloak, "
                "earmuffs in backpack", ++i);
   init_command("get toga from backpack", ++i);
   init_command("equip", ++i);
   costume = COSTUME_DESERT;
   return i;
}
int costume_wet() {
   int i;
   if (costume == COSTUME_WET) return 0;
   i = modesty();
   init_command("remove backpack", ++i);
   init_command("remove toga, cloak, earmuffs", ++i);
   init_command("put toga, cloak, earmuffs in backpack", ++i);
   init_command("get trousers, belt, shirt, hat, raincoat from "
                "backpack", ++i);
   init_command("equip", ++i);
   costume = COSTUME_WET;
   return i;
}
int costume_cold() {
  int i;
   if (costume == COSTUME_COLD) return 0;
   i = modesty();
   init_command("remove backpack", ++i);
   init_command("remove toga, raincoat, hat", ++i);
   init_command("put toga, raincoat, hat in backpack", ++i);
   init_command("get trousers, belt, shirt, cloak, earmuffs "
                "from backpack", ++i);
   init_command("equip", ++i);
   costume = COSTUME_COLD;
   return i;
}
void next_speech( object who, string message ) {
   if (who != pupil) return;
   if (speeching) return;
   impatience = 0;
   call_out("speech", 1);
}
void new_pupil( object who, string message ) {
   if ( pupil ) {
      if ( pupil == who ) {
         impatience = 0;
         init_command("pat " + who->short(), 1);
         init_command("'That's alright.  I understand you can get "
                      "excited at times like this.  Be assured that I am going "
                      "to teach you, " + who->short(), 3);
      } else {
         init_command("'sorry, " + who->short() + ", but I am teaching " +
                      pupil->short() + " right now.", 1);
      }
   } else {
      pupil = who;
      set_heart_beat(1);
      init_command("'Yes, " + pupil->short() +
                   ", I would be happy to teach you.", 1);
      init_command("drop sign", 3);
      init_command("stand", 4);
      init_command("'follow me, if you will", 6);
      impatience = 0;
   }
}
void new_rude_pupil( object who, string message ) {
   if (!pupil) {
      init_command("emote hums quietly to himself.", 2);
      init_command("mumble rude pupils", 5);
   }
}
mixed *stats() {
   return ::stats() +
      ({
         ({ "pupil", pupil ? pupil->query_name() : "no pupil" }),
         ({ "impatience", impatience }),
         ({ "costume", (costume == COSTUME_NORMAL) ? "normal" :
            ((costume == COSTUME_DESERT) ? "desert" :
             ((costume == COSTUME_WET) ? "wet" :
              ((costume == COSTUME_COLD) ? "cold" : "???"))) }),
         ({ "lesson step", lesson_step }),
      });
}

==================================================
FILE: dist/common.c
==================================================

#define DOM_TITLE "the domain of dist"
#define LORD "pinkfish"
#define DOMAIN "dist"
inherit "/std/dom/cmn_mas";
object board;
void setup() {
  set_dom(DOMAIN);
  set_light(100);
  add_exit("drum", "/d/am/am/mendeddrum", "door");
  set_short("Common room of "+DOM_TITLE);
  set_long("Large relaxing chairs addorn the room.  The walls are covered "+
           "with strange motifs from different lands and the little shelf "+
           "above the fireplace is chocker block full of strange figurines "+
           "and bits of cloth.  It appears to be the common room of "+
           DOM_TITLE+" the large red letters on the wall were the " +
           "give away.\n");
  add_alias("chairs", "chair");
  add_alias("cloths", "cloth");
  add_alias("motifs", "motif");
  add_alias("figurines", "figurine");
  add_item("chair", "The chairs are lazing around the room relaxing it looks "+
                    "like they come here after a hard days working in "+
                    DOM_TITLE+".\n");
  add_item("fireplace", "A nice little fire place with a cheery fire burning "+
                        "in it keeping every one warm.\n");
  add_item("figurine", "Small figurines, they look strangely familiar "+
                         "until you realise they are the members of "+
                         DOM_TITLE+".\n");
  add_item("cloth", "Strange coloured bits of cloth strewn over the "+
                    "mantlepice for no readily apparent reason.\n");
  add_item("motif", "The motifs on close inspection look like stylised "+
                     "signatures of all the members of "+DOM_TITLE+
                     ".  Some of them are very strange, in fact there "+
                     "seem to be more than there are members of the house.  "+
                     "perhaps it is the members of the future.\n");
  add_item("shelf", "A nice normal sort of shelf thing.  It is like all "+
                    "those ones you see in houses all over the place, "+
                    "execpt... the way it has been burnt... hmm it does "+
                    "not look like the fire did it.\n");
  add_item("fire", "There is a fire happily burning away in the fireplace "+
                   "spluttering and crackling to itself.  The flames almost "+
                   "seem afraid of something.  Looking closer you notice a "+
                   "picture tacked to the side of the fire place.\n");
  add_item("picture", "Tacked to the inside wall of the fire thingy, you "+
                      "know the hole bit at the bottom, is a small picture "+
                      "it looks like it was taken with the best of demon "+
                      "photography.  It is a picture of a person holding "+
                      "a small staff, you think it might be "+LORD+
                      " but you are not sure as the fire light sparkles "+
                      "in your eyes.\n");
  board = clone_object("/obj/misc/board");
  board->set_datafile(DOMAIN);
  board->move(this_object());
}
void dest_me()
{
  if(board) board->dest_me();
  ::dest_me();
}

==================================================
FILE: dist/loader.c
==================================================

#define DOMAIN "dist"
string *pre_load;
void create() {
  int i;
  seteuid((string)"/secure/master"->creator_file(file_name()));
  unguarded((: restore_object, file_name(this_object()) :));
  if (!pre_load)
    pre_load = ({ });
  for (i=0;i<sizeof(pre_load);i++) {
    printf(DOMAIN+" pre_loading "+pre_load[i]+".\n");
    if (catch(call_other(pre_load[i], "??")))
      call_out("do_load", 0, pre_load[i]);
  }
}
void do_load(string str) {
  call_other(str, "??");
}
int add_pre_load(string str) {
  if (member_array(str, pre_load) == -1)
    pre_load += ({ str });
  save_object(file_name(this_object()));
  return 1;
}
int remove_pre_load(string str) {
  int i;
  if ((i=member_array(str, pre_load)) == -1)
    return 0;
  pre_load = delete(pre_load, i, 1);
  save_object(file_name(this_object()));
}
string *query_pre_load() { return pre_load; }

==================================================
FILE: dist/master.c
==================================================

#define LORD "pinkfish"
#define DOMAIN "dist"
inherit "/std/dom/base_master";
string query_lord() {
  return LORD;
}
string author_file(string *path) {
  return capitalize(DOMAIN);
}
int check_permission(string euid, string *path, int mask) {
  if (euid == query_lord())
    return 1;
  return ::check_permission(euid, path, mask);
}
int valid_read(string *path, string euid, string funct);
int valid_write(string *path, string euid, string funct);
int query_member(string name) {
  return !undefinedp(members[name]) || name == LORD;
}
string log_who(string where) {
  return LORD;
}
string query_info() {
  return "";
}

==================================================
FILE: dist/start/entrance.c
==================================================

#include <config.h>
inherit "/std/room/basic_room";
void setup() {
   set_short("entrance");
   set_long("You are standing at the entrance to a big wide, well quite small, "
            "area.  Welcome to the Discworld mud distribution lib entrance.\n");
   set_light(70);
   add_exit("pumpkin", CONFIG_START_LOCATION, "road");
}
